<!DOCTYPE html>
<html>
    <head>
        <title>TEST</title>

        <script src="./WebSharper/WebSharper.js" type="text/javascript"></script>
        <script src="./WebSharper/IntelliFactory.WebSharper.dll.js" type="text/javascript"></script>
        <script src="./WebSharper/IntelliFactory.WebSharper.Collections.dll.js" type="text/javascript"></script>

        <script src="./gLong.js" type="text/javascript"></script>
        <script src="./output.js" type="text/javascript"></script>

        <script type="text/javascript">
        if (typeof IntelliFactory !== 'undefined')
            IntelliFactory.Runtime.Start();
        </script>
    </head>

    <body>
        <input type="file" id="files" />
        <output id="list"></output>

        <script>
            var mem_manager;

            function handleFileSelect(evt) {
                mem_manager = new SharedWorker('manager.js').port;
                mem_manager.start();
                mem_manager.onmessage = function(e) {
                    tag = e.data[0];
                    d = e.data[1];
                    if (tag == 'log') {
                        console.log("MANAGER: " + d);
                    } else {
                        spawnThread(d);
                    }
                }
                var file = evt.target.files[0];
                var reader = new FileReader();
                reader.onload = function(e) {
                    var bytes = e.target.result;
                    mem_manager.postMessage(bytes);
                    //mem_manager.postMessage(bytes, [bytes]);
                }
                reader.readAsArrayBuffer(file);
            }

            document.getElementById('files').addEventListener('change', handleFileSelect, false);

            function spawnThread(args) {
                m = new SharedWorker('manager.js');
                w = new Worker('thread.js');
                w.onmessage = function(e) {
                    console.log(e.data);
                }
                w.postMessage([m.port, args], [m.port]);
                return w;
            }
        </script>

    </body
</html>
